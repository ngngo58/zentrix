<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロジェクト管理ツール</title>
    <style>
        /* --- ここからCSS --- */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #e67e22;
            --danger-color: #e74c3c;
            --warning-color: #f1c40f;
            --light-bg: #f4f7f6;
            --white-bg: #ffffff;
            --text-color: #333333;
            --border-color: #dddddd;
            --header-bg: #ecf0f1;
            --delayed-bg: #fadbd8;
            --due-soon-bg: #fef9e7;
            --completed-bg: #e8f5e9;
            --font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            --chu-komoku-bg: #e0f2fe; /* 中項目の背景色 */
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--text-color);
            font-size: 14px;
            line-height: 1.6;
        }

        .container {
            background-color: var(--white-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 1400px;
            margin: 20px auto;
        }

        h1, h2, h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
        }
        h1 { font-size: 2em; text-align: center; margin-bottom: 25px; }
        h2 { font-size: 1.5em; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;}
        h3 { font-size: 1.2em; }

        .file-upload-area {
            margin-bottom: 25px; padding: 20px; background-color: #eaf2f8;
            border-radius: 8px; border: 2px dashed var(--primary-color); text-align: center;
        }
        .file-upload-area input[type="file"] {
            padding: 10px; border: 1px solid var(--border-color); border-radius: 5px;
            margin-right: 10px; background-color: var(--white-bg);
        }
        .action-button, .file-upload-area button, .filter-area button {
            padding: 10px 18px; background-color: var(--primary-color); color: white;
            border: none; border-radius: 5px; cursor: pointer; font-size: 1em;
            transition: background-color 0.3s ease;
            margin-left: 5px; 
        }
        .action-button:first-child, .file-upload-area button:first-child, .filter-area button:first-child {
            margin-left: 0;
        }
        .action-button:hover, .file-upload-area button:hover, .filter-area button:hover {
            background-color: #2980b9;
        }
        .action-button.reset { background-color: var(--accent-color); }
        .action-button.reset:hover { background-color: #d35400; }
        .action-button.update { background-color: var(--secondary-color); } 
        .action-button.update:hover { background-color: #27ae60; }
        .action-button.small {
            padding: 4px 8px; font-size: 0.9em; line-height: 1.2; vertical-align: middle;
        }

        .summary-section { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .summary-area, .assignee-summary-area {
            flex: 1; min-width: 300px; padding: 15px; background-color: #f9f9f9;
            border-radius: 8px; border: 1px solid #e0e0e0;
        }
        .summary-item { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .summary-item strong { color: #555; }
        .overall-progress { display: flex; align-items: center; font-size: 1.1em; }
        .overall-progress .progress-pie-chart { width: 30px; height: 30px; margin-right: 10px; }
        .overall-progress span { font-weight: bold; }

        .filter-area {
            margin-bottom: 25px; padding: 20px; background-color: #fdf2e9;
            border-radius: 8px; border: 1px solid #fae5d3;
        }
        .filter-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; } 
        .filter-controls > div { margin-right: 15px;} 
        .filter-controls label { font-weight: bold; margin-right: 5px; }
        .filter-controls select, .filter-controls input[type="text"] {
            padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); min-width: 150px;
        }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th, td {
            border: 1px solid var(--border-color); padding: 10px 12px;
            vertical-align: middle; font-size: 0.95em;
        }
        th {
            background-color: var(--header-bg); color: #34495e; font-weight: bold;
            cursor: pointer; position: relative; white-space: nowrap;
            text-align: center;
        }
        td {
            text-align: left; 
        }
        th .sort-icon { margin-left: 8px; font-size: 0.9em; color: var(--primary-color); }

        .toggle-icon {
            cursor: pointer; margin-right: 8px; font-weight: bold; color: var(--primary-color);
            display: inline-block; width: 20px; text-align: center; font-size: 1.1em;
            transition: transform 0.2s ease-in-out;
            flex-shrink: 0;
        }
        .task-row.collapsed .toggle-icon { transform: rotate(-90deg); }
        .task-row:not(.collapsed) .toggle-icon::before { content: '▼'; }
        .task-row.collapsed .toggle-icon::before { content: '▶'; }

        .task-row.level-0 { font-weight: bold; background-color: #e9f7ef; } /* 大項目の背景色 */
        .task-row.level-1 { background-color: var(--chu-komoku-bg); } /* 中項目の背景色 */

        .task-row.level-0 td:nth-child(1),
        .task-row.level-1 td:nth-child(1), /* colspan適用後、中項目名も最初のセルになる */
        .task-row.level-2 td:nth-child(1) { /* 小項目名も最初のセルになる */
            display: flex;
            align-items: center;
            text-align: left !important;
        }
        /* インデントは各階層の最初の表示セルに適用 */
        .task-row.level-0 td:nth-child(1) { padding-left: 15px !important; }
        .task-row.level-1 td:nth-child(1) { padding-left: 40px !important; }
        .task-row.level-2 td:nth-child(1) { padding-left: 65px !important; } /* 小項目は3番目のヘッダーに対応するが、描画上は1番目のデータセル */
        
        .task-row.level-2 td.sho-komoku-cell { /* 小項目名が入る実際のセル */
            white-space: normal; 
            word-break: break-all; 
            min-width: 150px; 
            text-align: left; /* Added this line */
        }

        .level-2 .toggle-icon { visibility: hidden; }
        .progress-count {
            font-size: 0.9em; color: #777; margin-left: 8px; background-color: #e0e0e0;
            padding: 2px 6px; border-radius: 4px;
        }
        .progress-select {
            margin-left: 5px;
            padding: 3px;
            border-radius: 3px;
            border: 1px solid var(--border-color);
            font-size: 0.9em;
        }

        .status-delayed { background-color: var(--delayed-bg) !important; }
        .status-due-soon { background-color: var(--due-soon-bg) !important; }
        .status-completed .progress-pie-chart { background-image: conic-gradient(var(--secondary-color) 0% 100%, #efefef 100% 100%) !important; }

        .progress-pie-chart {
            width: 28px; height: 28px; border-radius: 50%; display: inline-block;
            vertical-align: middle; margin-right: 8px; background-color: #efefef; position: relative;
        }
        .progress-pie-chart::before {
            content: ""; position: absolute; top: 50%; left: 50%; width: 60%; height: 60%;
            background-color: var(--white-bg); border-radius: 50%; transform: translate(-50%, -50%); z-index: 1;
        }
        .progress-pie-chart-inner { width: 100%; height: 100%; border-radius: 50%; position: absolute; top:0; left:0; z-index: 0; }

        .remarks-textarea {
            width: calc(100% - 12px); min-height: 40px; border: 1px solid var(--border-color);
            border-radius: 5px; padding: 5px; font-size: 13px; box-sizing: border-box;
            transition: box-shadow 0.2s ease; margin-top: 2px;
        }
        .remarks-textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 5px rgba(52, 152, 219, 0.5); outline: none; }

        .legend-area { margin-top: 30px; padding: 20px; background-color: #f0f0f0; border-radius: 8px; }
        .legend-item { margin-bottom: 8px; display: flex; align-items: center; }
        .legend-color-box { width: 20px; height: 20px; display: inline-block; margin-right: 10px; border: 1px solid #ccc; vertical-align: middle; border-radius: 3px;}
        .loader { border: 6px solid #f3f3f3; border-top: 6px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 30px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { background-color: var(--danger-color); color: white; padding: 10px 15px; border-radius: 5px; margin-bottom: 15px; text-align: center; }
        .help-icon { position: fixed; bottom: 20px; right: 20px; background-color: var(--accent-color); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; }
        
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background-color: var(--white-bg); padding: 30px; border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); width: 90%; max-width: 600px;
            max-height: 80vh; overflow-y: auto; position: relative;
        }
        .modal-content .close-button {
            position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold;
            cursor: pointer; color: #888; line-height: 1;
        }
        .modal-content .close-button:hover { color: #333; }
        #detailModalBody { margin-top: 15px; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; }
        #detailModalBody h4 { margin-top: 10px; margin-bottom: 5px; color: var(--primary-color); }
        #detailModalBody p { margin-top: 0; margin-bottom: 15px; }
        #detailModalBody hr { margin: 15px 0; border: 0; border-top: 1px solid #eee; }

        @media (max-width: 768px) { body { padding: 10px; } .container { padding: 15px; } h1 { font-size: 1.5em; } h2 { font-size: 1.2em; } .filter-controls { flex-direction: column; gap: 10px; align-items: stretch; } .filter-controls select, .filter-controls input[type="text"], .filter-controls button { width: 100%; margin-right: 0; } .summary-section { flex-direction: column; } th, td { padding: 8px 10px; font-size: 0.9em; } .task-row.level-0 td:nth-child(1) { padding-left: 10px !important; } .task-row.level-1 td:nth-child(1) { padding-left: 25px !important; } .task-row.level-2 td:nth-child(1) { padding-left: 40px !important; } .help-icon { width: 40px; height: 40px; font-size: 20px; bottom: 10px; right: 10px;} }
    </style>
</head>
<body>
    <div class="container">
        <h1>プロジェクト管理ツール</h1>
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div class="file-upload-area">
            <h2>1. CSVファイルアップロード</h2>
            <input type="file" id="csvFile" accept=".csv">
            <p style="font-size: 0.9em; color: #555; margin-top:10px;">
                UTF-8エンコードのCSVファイルをアップロードしてください。<br>
                必須列: 大項目, 中項目, 小項目 (その他項目は空白許容)<br>
                推奨列順: 大項目, 中項目, 小項目, 実施内容, 開始日予定日, 終了日予定日, 開始日, 終了日, 担当, 進捗率, 備考
            </p>
        </div>
        <div class="loader" id="loader"></div>
        <div id="mainContent" style="display: none;">
            <div class="summary-section">
                <div class="summary-area">
                    <h3>プロジェクト全体サマリー</h3>
                    <div class="summary-item overall-progress"><strong>全体進捗率:</strong><div><div class="progress-pie-chart" id="overallProgressPie"><div class="progress-pie-chart-inner"></div></div><span id="overallProgressText">0%</span></div></div>
                    <div class="summary-item"><strong>総小項目数:</strong> <span id="totalTasks">0</span></div>
                    <div class="summary-item"><strong>完了小項目数:</strong> <span id="completedTasks">0</span></div>
                    <div class="summary-item"><strong>未完了小項目数:</strong> <span id="incompleteTasks">0</span></div>
                    <div class="summary-item"><strong>遅延小項目数:</strong> <span id="delayedTasksSummary">0</span></div>
                    <div class="summary-item"><strong>期日近接小項目数:</strong> <span id="dueSoonTasksSummary">0</span></div>
                </div>
                <div class="assignee-summary-area">
                    <h3>担当別サマリー</h3>
                    <div class="table-container"><table id="assigneeSummaryTable"><thead><tr><th>担当</th><th>総タスク</th><th>未完了</th><th>完了</th><th>遅延</th><th>期日近接</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>
            <div class="filter-area">
                <h3>絞り込み・並び替え</h3>
                <div class="filter-controls">
                    <div><label for="filterDaiKomoku">大項目:</label><select id="filterDaiKomoku"><option value="">すべて</option></select></div>
                    <div><label for="filterTantou">担当:</label><select id="filterTantou"><option value="">すべて</option></select></div>
                    <div><label for="filterStatus">ステータス:</label><select id="filterStatus"><option value="">すべて</option><option value="未着手">未着手</option><option value="進行中">進行中</option><option value="完了">完了</option><option value="遅延">遅延</option><option value="期日近接">期日近接</option></select></div>
                    <button id="applyFilterButton" class="action-button">絞り込み適用</button>
                    <button id="resetFilterButton" class="action-button reset">リセット</button>
                    <button id="updateProgressButton" class="action-button update">進捗を一括更新</button> </div>
            </div>
            <div class="table-container">
                <table id="projectTable">
                    <thead><tr><th data-sort="daiKomoku">大項目 <span class="sort-icon"></span></th><th data-sort="chuKomoku">中項目 <span class="sort-icon"></span></th><th data-sort="shoKomoku">小項目 <span class="sort-icon"></span></th><th data-sort="jisshiNaiyo">実施内容 <span class="sort-icon"></span></th><th data-sort="kaishiYoteiBi">開始日予定日 <span class="sort-icon"></span></th><th data-sort="shuryoYoteiBi">終了日予定日 <span class="sort-icon"></span></th><th data-sort="kaishiBi">開始日 <span class="sort-icon"></span></th><th data-sort="shuryoBi">終了日 <span class="sort-icon"></span></th><th data-sort="tantou">担当 <span class="sort-icon"></span></th><th data-sort="shinchokuRitsu">進捗率 <span class="sort-icon"></span></th><th>備考</th></tr></thead>
                    <tbody id="projectTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="help-icon" id="helpIcon">?</div>
    <div class="legend-modal modal-overlay" id="legendModal"> <div class="modal-content">
            <span class="close-button" id="closeLegendModal">&times;</span><h3>凡例</h3>
            <div class="legend-area">
                <div class="legend-item"><span class="legend-color-box" style="background-color: var(--delayed-bg);"></span> 遅延 (期限切れ未完了)</div>
                <div class="legend-item"><span class="legend-color-box" style="background-color: var(--due-soon-bg);"></span> 期日近接 (3日以内未完了)</div>
                <div class="legend-item"><span class="toggle-icon" style="transform: rotate(0);">▼</span> 展開中</div>
                <div class="legend-item"><span class="toggle-icon" style="transform: rotate(-90deg);">▶</span> 折りたたみ中</div>
                <div class="legend-item"><div class="progress-pie-chart" style="background-image: conic-gradient(var(--secondary-color) 0% 75%, #efefef 75% 100%);"><div class="progress-pie-chart-inner"></div></div> 進捗率 75%</div>
                <div class="legend-item"><div class="progress-pie-chart" style="background-image: conic-gradient(var(--warning-color) 0% 40%, #efefef 40% 100%);"><div class="progress-pie-chart-inner"></div></div> 進捗率 40%</div>
                <div class="legend-item"><div class="progress-pie-chart" style="background-image: conic-gradient(var(--danger-color) 0% 10%, #efefef 10% 100%);"><div class="progress-pie-chart-inner"></div></div> 進捗率 10%</div>
            </div>
        </div>
    </div>
    <div id="detailModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" id="closeDetailModalButton">&times;</span>
            <h3 id="detailModalTitle">詳細内容</h3>
            <div id="detailModalBody"></div>
        </div>
    </div>

    <script id="papaparse-script-container">
   /* @license
Papa Parse
v5.4.1
https://github.com/mholt/PapaParse
License: MIT
*/
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&"undefined"!=typeof exports?module.exports=t():e.Papa=t()}(this,function s(){"use strict";var f="undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==f?f:{};var n=!f.document&&!!f.postMessage,o=f.IS_PAPA_WORKER||!1,a={},u=0,b={parse:function(e,t){var r=(t=t||{}).dynamicTyping||!1;J(r)&&(t.dynamicTypingFunction=r,r={});if(t.dynamicTyping=r,t.transform=!!J(t.transform)&&t.transform,t.worker&&b.WORKERS_SUPPORTED){var i=function(){if(!b.WORKERS_SUPPORTED)return!1;var e=(r=f.URL||f.webkitURL||null,i=s.toString(),b.BLOB_URL||(b.BLOB_URL=r.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",i,")();"],{type:"text/javascript"})))),t=new f.Worker(e);var r,i;return t.onmessage=_,t.id=u++,a[t.id]=t}();return i.userStep=t.step,i.userChunk=t.chunk,i.userComplete=t.complete,i.userError=t.error,t.step=J(t.step),t.chunk=J(t.chunk),t.complete=J(t.complete),t.error=J(t.error),delete t.worker,void i.postMessage({input:e,config:t,workerId:i.id})}var n=null;b.NODE_STREAM_INPUT,"string"==typeof e?(e=function(e){if(65279===e.charCodeAt(0))return e.slice(1);return e}(e),n=t.download?new l(t):new p(t)):!0===e.readable&&J(e.read)&&J(e.on)?n=new g(t):(f.File&&e instanceof File||e instanceof Object)&&(n=new c(t));return n.stream(e)},unparse:function(e,t){var n=!1,_=!0,m=",",y="\r\n",s='"',a=s+s,r=!1,i=null,o=!1;!function(){if("object"!=typeof t)return;"string"!=typeof t.delimiter||b.BAD_DELIMITERS.filter(function(e){return-1!==t.delimiter.indexOf(e)}).length||(m=t.delimiter);("boolean"==typeof t.quotes||"function"==typeof t.quotes||Array.isArray(t.quotes))&&(n=t.quotes);"boolean"!=typeof t.skipEmptyLines&&"string"!=typeof t.skipEmptyLines||(r=t.skipEmptyLines);"string"==typeof t.newline&&(y=t.newline);"string"==typeof t.quoteChar&&(s=t.quoteChar);"boolean"==typeof t.header&&(_=t.header);if(Array.isArray(t.columns)){if(0===t.columns.length)throw new Error("Option columns is empty");i=t.columns}void 0!==t.escapeChar&&(a=t.escapeChar+s);("boolean"==typeof t.escapeFormulae||t.escapeFormulae instanceof RegExp)&&(o=t.escapeFormulae instanceof RegExp?t.escapeFormulae:/^[=+\-@\t\r].*$/)}();var u=new RegExp(Q(s),"g");"string"==typeof e&&(e=JSON.parse(e));if(Array.isArray(e)){if(!e.length||Array.isArray(e[0]))return h(null,e,r);if("object"==typeof e[0])return h(i||Object.keys(e[0]),e,r)}else if("object"==typeof e)return"string"==typeof e.data&&(e.data=JSON.parse(e.data)),Array.isArray(e.data)&&(e.fields||(e.fields=e.meta&&e.meta.fields||i),e.fields||(e.fields=Array.isArray(e.data[0])?e.fields:"object"==typeof e.data[0]?Object.keys(e.data[0]):[]),Array.isArray(e.data[0])||"object"==typeof e.data[0]||(e.data=[e.data])),h(e.fields||[],e.data||[],r);throw new Error("Unable to serialize unrecognized input");function h(e,t,r){var i="";"string"==typeof e&&(e=JSON.parse(e)),"string"==typeof t&&(t=JSON.parse(t));var n=Array.isArray(e)&&0<e.length,s=!Array.isArray(t[0]);if(n&&_){for(var a=0;a<e.length;a++)0<a&&(i+=m),i+=v(e[a],a);0<t.length&&(i+=y)}for(var o=0;o<t.length;o++){var u=n?e.length:t[o].length,h=!1,f=n?0===Object.keys(t[o]).length:0===t[o].length;if(r&&!n&&(h="greedy"===r?""===t[o].join("").trim():1===t[o].length&&0===t[o][0].length),"greedy"===r&&n){for(var d=[],l=0;l<u;l++){var c=s?e[l]:l;d.push(t[o][c])}h=""===d.join("").trim()}if(!h){for(var p=0;p<u;p++){0<p&&!f&&(i+=m);var g=n&&s?e[p]:p;i+=v(t[o][g],p)}o<t.length-1&&(!r||0<u&&!f)&&(i+=y)}}return i}function v(e,t){if(null==e)return"";if(e.constructor===Date)return JSON.stringify(e).slice(1,25);var r=!1;o&&"string"==typeof e&&o.test(e)&&(e="'"+e,r=!0);var i=e.toString().replace(u,a);return(r=r||!0===n||"function"==typeof n&&n(e,t)||Array.isArray(n)&&n[t]||function(e,t){for(var r=0;r<t.length;r++)if(-1<e.indexOf(t[r]))return!0;return!1}(i,b.BAD_DELIMITERS)||-1<i.indexOf(m)||" "===i.charAt(0)||" "===i.charAt(i.length-1))?s+i+s:i}}};if(b.RECORD_SEP=String.fromCharCode(30),b.UNIT_SEP=String.fromCharCode(31),b.BYTE_ORDER_MARK="\ufeff",b.BAD_DELIMITERS=["\r","\n",'"',b.BYTE_ORDER_MARK],b.WORKERS_SUPPORTED=!n&&!!f.Worker,b.NODE_STREAM_INPUT=1,b.LocalChunkSize=10485760,b.RemoteChunkSize=5242880,b.DefaultDelimiter=",",b.Parser=E,b.ParserHandle=r,b.NetworkStreamer=l,b.FileStreamer=c,b.StringStreamer=p,b.ReadableStreamStreamer=g,f.jQuery){var d=f.jQuery;d.fn.parse=function(o){var r=o.config||{},u=[];return this.each(function(e){if(!("INPUT"===d(this).prop("tagName").toUpperCase()&&"file"===d(this).attr("type").toLowerCase()&&f.FileReader)||!this.files||0===this.files.length)return!0;for(var t=0;t<this.files.length;t++)u.push({file:this.files[t],inputElem:this,instanceConfig:d.extend({},r)})}),e(),this;function e(){if(0!==u.length){var e,t,r,i,n=u[0];if(J(o.before)){var s=o.before(n.file,n.inputElem);if("object"==typeof s){if("abort"===s.action)return e="AbortError",t=n.file,r=n.inputElem,i=s.reason,void(J(o.error)&&o.error({name:e},t,r,i));if("skip"===s.action)return void h();"object"==typeof s.config&&(n.instanceConfig=d.extend(n.instanceConfig,s.config))}else if("skip"===s)return void h()}var a=n.instanceConfig.complete;n.instanceConfig.complete=function(e){J(a)&&a(e,n.file,n.inputElem),h()},b.parse(n.file,n.instanceConfig)}else J(o.complete)&&o.complete()}function h(){u.splice(0,1),e()}}}function h(e){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},function(e){var t=w(e);t.chunkSize=parseInt(t.chunkSize),e.step||e.chunk||(t.chunkSize=null);this._handle=new r(t),(this._handle.streamer=this)._config=t}.call(this,e),this.parseChunk=function(e,t){if(this.isFirstChunk&&J(this._config.beforeFirstChunk)){var r=this._config.beforeFirstChunk(e);void 0!==r&&(e=r)}this.isFirstChunk=!1,this._halted=!1;var i=this._partialLine+e;this._partialLine="";var n=this._handle.parse(i,this._baseIndex,!this._finished);if(!this._handle.paused()&&!this._handle.aborted()){var s=n.meta.cursor;this._finished||(this._partialLine=i.substring(s-this._baseIndex),this._baseIndex=s),n&&n.data&&(this._rowCount+=n.data.length);var a=this._finished||this._config.preview&&this._rowCount>=this._config.preview;if(o)f.postMessage({results:n,workerId:b.WORKER_ID,finished:a});else if(J(this._config.chunk)&&!t){if(this._config.chunk(n,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);n=void 0,this._completeResults=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(n.data),this._completeResults.errors=this._completeResults.errors.concat(n.errors),this._completeResults.meta=n.meta),this._completed||!a||!J(this._config.complete)||n&&n.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),a||n&&n.meta.paused||this._nextChunk(),n}this._halted=!0},this._sendError=function(e){J(this._config.error)?this._config.error(e):o&&this._config.error&&f.postMessage({workerId:b.WORKER_ID,error:e,finished:!1})}}function l(e){var i;(e=e||{}).chunkSize||(e.chunkSize=b.RemoteChunkSize),h.call(this,e),this._nextChunk=n?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(e){this._input=e,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(i=new XMLHttpRequest,this._config.withCredentials&&(i.withCredentials=this._config.withCredentials),n||(i.onload=v(this._chunkLoaded,this),i.onerror=v(this._chunkError,this)),i.open(this._config.downloadRequestBody?"POST":"GET",this._input,!n),this._config.downloadRequestHeaders){var e=this._config.downloadRequestHeaders;for(var t in e)i.setRequestHeader(t,e[t])}if(this._config.chunkSize){var r=this._start+this._config.chunkSize-1;i.setRequestHeader("Range","bytes="+this._start+"-"+r)}try{i.send(this._config.downloadRequestBody)}catch(e){this._chunkError(e.message)}n&&0===i.status&&this._chunkError()}},this._chunkLoaded=function(){4===i.readyState&&(i.status<200||400<=i.status?this._chunkError():(this._start+=this._config.chunkSize?this._config.chunkSize:i.responseText.length,this._finished=!this._config.chunkSize||this._start>=function(e){var t=e.getResponseHeader("Content-Range");if(null===t)return-1;return parseInt(t.substring(t.lastIndexOf("/")+1))}(i),this.parseChunk(i.responseText)))},this._chunkError=function(e){var t=i.statusText||e;this._sendError(new Error(t))}}function c(e){var i,n;(e=e||{}).chunkSize||(e.chunkSize=b.LocalChunkSize),h.call(this,e);var s="undefined"!=typeof FileReader;this.stream=function(e){this._input=e,n=e.slice||e.webkitSlice||e.mozSlice,s?((i=new FileReader).onload=v(this._chunkLoaded,this),i.onerror=v(this._chunkError,this)):i=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var e=this._input;if(this._config.chunkSize){var t=Math.min(this._start+this._config.chunkSize,this._input.size);e=n.call(e,this._start,t)}var r=i.readAsText(e,this._config.encoding);s||this._chunkLoaded({target:{result:r}})},this._chunkLoaded=function(e){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(e.target.result)},this._chunkError=function(){this._sendError(i.error)}}function p(e){var r;h.call(this,e=e||{}),this.stream=function(e){return r=e,this._nextChunk()},this._nextChunk=function(){if(!this._finished){var e,t=this._config.chunkSize;return t?(e=r.substring(0,t),r=r.substring(t)):(e=r,r=""),this._finished=!r,this.parseChunk(e)}}}function g(e){h.call(this,e=e||{});var t=[],r=!0,i=!1;this.pause=function(){h.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){h.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(e){this._input=e,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){i&&1===t.length&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),t.length?this.parseChunk(t.shift()):r=!0},this._streamData=v(function(e){try{t.push("string"==typeof e?e:e.toString(this._config.encoding)),r&&(r=!1,this._checkIsFinished(),this.parseChunk(t.shift()))}catch(e){this._streamError(e)}},this),this._streamError=v(function(e){this._streamCleanUp(),this._sendError(e)},this),this._streamEnd=v(function(){this._streamCleanUp(),i=!0,this._streamData("")},this),this._streamCleanUp=v(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function r(m){var a,o,u,i=Math.pow(2,53),n=-i,s=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,h=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,t=this,r=0,f=0,d=!1,e=!1,l=[],c={data:[],errors:[],meta:{}};if(J(m.step)){var p=m.step;m.step=function(e){if(c=e,_())g();else{if(g(),0===c.data.length)return;r+=e.data.length,m.preview&&r>m.preview?o.abort():(c.data=c.data[0],p(c,t))}}}function y(e){return"greedy"===m.skipEmptyLines?""===e.join("").trim():1===e.length&&0===e[0].length}function g(){return c&&u&&(k("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+b.DefaultDelimiter+"'"),u=!1),m.skipEmptyLines&&(c.data=c.data.filter(function(e){return!y(e)})),_()&&function(){if(!c)return;function e(e,t){J(m.transformHeader)&&(e=m.transformHeader(e,t)),l.push(e)}if(Array.isArray(c.data[0])){for(var t=0;_()&&t<c.data.length;t++)c.data[t].forEach(e);c.data.splice(0,1)}else c.data.forEach(e)}(),function(){if(!c||!m.header&&!m.dynamicTyping&&!m.transform)return c;function e(e,t){var r,i=m.header?{}:[];for(r=0;r<e.length;r++){var n=r,s=e[r];m.header&&(n=r>=l.length?"__parsed_extra":l[r]),m.transform&&(s=m.transform(s,n)),s=v(n,s),"__parsed_extra"===n?(i[n]=i[n]||[],i[n].push(s)):i[n]=s}return m.header&&(r>l.length?k("FieldMismatch","TooManyFields","Too many fields: expected "+l.length+" fields but parsed "+r,f+t):r<l.length&&k("FieldMismatch","TooFewFields","Too few fields: expected "+l.length+" fields but parsed "+r,f+t)),i}var t=1;!c.data.length||Array.isArray(c.data[0])?(c.data=c.data.map(e),t=c.data.length):c.data=e(c.data,0);m.header&&c.meta&&(c.meta.fields=l);return f+=t,c}()}function _(){return m.header&&0===l.length}function v(e,t){return r=e,m.dynamicTypingFunction&&void 0===m.dynamicTyping[r]&&(m.dynamicTyping[r]=m.dynamicTypingFunction(r)),!0===(m.dynamicTyping[r]||m.dynamicTyping)?"true"===t||"TRUE"===t||"false"!==t&&"FALSE"!==t&&(function(e){if(s.test(e)){var t=parseFloat(e);if(n<t&&t<i)return!0}return!1}(t)?parseFloat(t):h.test(t)?new Date(t):""===t?null:t):t;var r}function k(e,t,r,i){var n={type:e,code:t,message:r};void 0!==i&&(n.row=i),c.errors.push(n)}this.parse=function(e,t,r){var i=m.quoteChar||'"';if(m.newline||(m.newline=function(e,t){e=e.substring(0,1048576);var r=new RegExp(Q(t)+"([^]*?)"+Q(t),"gm"),i=(e=e.replace(r,"")).split("\r"),n=e.split("\n"),s=1<n.length&&n[0].length<i[0].length;if(1===i.length||s)return"\n";for(var a=0,o=0;o<i.length;o++)"\n"===i[o][0]&&a++;return a>=i.length/2?"\r\n":"\r"}(e,i)),u=!1,m.delimiter)J(m.delimiter)&&(m.delimiter=m.delimiter(e),c.meta.delimiter=m.delimiter);else{var n=function(e,t,r,i,n){var s,a,o,u;n=n||[",","\t","|",";",b.RECORD_SEP,b.UNIT_SEP];for(var h=0;h<n.length;h++){var f=n[h],d=0,l=0,c=0;o=void 0;for(var p=new E({comments:i,delimiter:f,newline:t,preview:10}).parse(e),g=0;g<p.data.length;g++)if(r&&y(p.data[g]))c++;else{var _=p.data[g].length;l+=_,void 0!==o?0<_&&(d+=Math.abs(_-o),o=_):o=_}0<p.data.length&&(l/=p.data.length-c),(void 0===a||d<=a)&&(void 0===u||u<l)&&1.99<l&&(a=d,s=f,u=l)}return{successful:!!(m.delimiter=s),bestDelimiter:s}}(e,m.newline,m.skipEmptyLines,m.comments,m.delimitersToGuess);n.successful?m.delimiter=n.bestDelimiter:(u=!0,m.delimiter=b.DefaultDelimiter),c.meta.delimiter=m.delimiter}var s=w(m);return m.preview&&m.header&&s.preview++,a=e,o=new E(s),c=o.parse(a,t,r),g(),d?{meta:{paused:!0}}:c||{meta:{paused:!1}}},this.paused=function(){return d},this.pause=function(){d=!0,o.abort(),a=J(m.chunk)?"":a.substring(o.getCharIndex())},this.resume=function(){t.streamer._halted?(d=!1,t.streamer.parseChunk(a,!0)):setTimeout(t.resume,3)},this.aborted=function(){return e},this.abort=function(){e=!0,o.abort(),c.meta.aborted=!0,J(m.complete)&&m.complete(c),a=""}}function Q(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function E(j){var z,M=(j=j||{}).delimiter,P=j.newline,U=j.comments,q=j.step,N=j.preview,B=j.fastMode,K=z=void 0===j.quoteChar||null===j.quoteChar?'"':j.quoteChar;if(void 0!==j.escapeChar&&(K=j.escapeChar),("string"!=typeof M||-1<b.BAD_DELIMITERS.indexOf(M))&&(M=","),U===M)throw new Error("Comment character same as delimiter");!0===U?U="#":("string"!=typeof U||-1<b.BAD_DELIMITERS.indexOf(U))&&(U=!1),"\n"!==P&&"\r"!==P&&"\r\n"!==P&&(P="\n");var W=0,H=!1;this.parse=function(i,t,r){if("string"!=typeof i)throw new Error("Input must be a string");var n=i.length,e=M.length,s=P.length,a=U.length,o=J(q),u=[],h=[],f=[],d=W=0;if(!i)return L();if(j.header&&!t){var l=i.split(P)[0].split(M),c=[],p={},g=!1;for(var _ in l){var m=l[_];J(j.transformHeader)&&(m=j.transformHeader(m,_));var y=m,v=p[m]||0;for(0<v&&(g=!0,y=m+"_"+v),p[m]=v+1;c.includes(y);)y=y+"_"+v;c.push(y)}if(g){var k=i.split(P);k[0]=c.join(M),i=k.join(P)}}if(B||!1!==B&&-1===i.indexOf(z)){for(var b=i.split(P),E=0;E<b.length;E++){if(f=b[E],W+=f.length,E!==b.length-1)W+=P.length;else if(r)return L();if(!U||f.substring(0,a)!==U){if(o){if(u=[],I(f.split(M)),F(),H)return L()}else I(f.split(M));if(N&&N<=E)return u=u.slice(0,N),L(!0)}}return L()}for(var w=i.indexOf(M,W),R=i.indexOf(P,W),C=new RegExp(Q(K)+Q(z),"g"),S=i.indexOf(z,W);;)if(i[W]!==z)if(U&&0===f.length&&i.substring(W,W+a)===U){if(-1===R)return L();W=R+s,R=i.indexOf(P,W),w=i.indexOf(M,W)}else if(-1!==w&&(w<R||-1===R))f.push(i.substring(W,w)),W=w+e,w=i.indexOf(M,W);else{if(-1===R)break;if(f.push(i.substring(W,R)),D(R+s),o&&(F(),H))return L();if(N&&u.length>=N)return L(!0)}else for(S=W,W++;;){if(-1===(S=i.indexOf(z,S+1)))return r||h.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:u.length,index:W}),T();if(S===n-1)return T(i.substring(W,S).replace(C,z));if(z!==K||i[S+1]!==K){if(z===K||0===S||i[S-1]!==K){-1!==w&&w<S+1&&(w=i.indexOf(M,S+1)),-1!==R&&R<S+1&&(R=i.indexOf(P,S+1));var O=A(-1===R?w:Math.min(w,R));if(i.substr(S+1+O,e)===M){f.push(i.substring(W,S).replace(C,z)),i[W=S+1+O+e]!==z&&(S=i.indexOf(z,W)),w=i.indexOf(M,W),R=i.indexOf(P,W);break}var x=A(R);if(i.substring(S+1+x,S+1+x+s)===P){if(f.push(i.substring(W,S).replace(C,z)),D(S+1+x+s),w=i.indexOf(M,W),S=i.indexOf(z,W),o&&(F(),H))return L();if(N&&u.length>=N)return L(!0);break}h.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:u.length,index:W}),S++}}else S++}return T();function I(e){u.push(e),d=W}function A(e){var t=0;if(-1!==e){var r=i.substring(S+1,e);r&&""===r.trim()&&(t=r.length)}return t}function T(e){return r||(void 0===e&&(e=i.substring(W)),f.push(e),W=n,I(f),o&&F()),L()}function D(e){W=e,I(f),f=[],R=i.indexOf(P,W)}function L(e){return{data:u,errors:h,meta:{delimiter:M,linebreak:P,aborted:H,truncated:!!e,cursor:d+(t||0)}}}function F(){q(L()),u=[],h=[]}},this.abort=function(){H=!0},this.getCharIndex=function(){return W}}function _(e){var t=e.data,r=a[t.workerId],i=!1;if(t.error)r.userError(t.error,t.file);else if(t.results&&t.results.data){var n={abort:function(){i=!0,m(t.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:y,resume:y};if(J(r.userStep)){for(var s=0;s<t.results.data.length&&(r.userStep({data:t.results.data[s],errors:t.results.errors,meta:t.results.meta},n),!i);s++);delete t.results}else J(r.userChunk)&&(r.userChunk(t.results,n,t.file),delete t.results)}t.finished&&!i&&m(t.workerId,t.results)}function m(e,t){var r=a[e];J(r.userComplete)&&r.userComplete(t),r.terminate(),delete a[e]}function y(){throw new Error("Not implemented.")}function w(e){if("object"!=typeof e||null===e)return e;var t=Array.isArray(e)?[]:{};for(var r in e)t[r]=w(e[r]);return t}function v(e,t){return function(){e.apply(t,arguments)}}function J(e){return"function"==typeof e}return o&&(f.onmessage=function(e){var t=e.data;void 0===b.WORKER_ID&&t&&(b.WORKER_ID=t.workerId);if("string"==typeof t.input)f.postMessage({workerId:b.WORKER_ID,results:b.parse(t.input,t.config),finished:!0});else if(f.File&&t.input instanceof File||t.input instanceof Object){var r=b.parse(t.input,t.config);r&&f.postMessage({workerId:b.WORKER_ID,results:r,finished:!0})}}),(l.prototype=Object.create(h.prototype)).constructor=l,(c.prototype=Object.create(h.prototype)).constructor=c,(p.prototype=Object.create(p.prototype)).constructor=p,(g.prototype=Object.create(h.prototype)).constructor=g,b});
    </script>
    <script>
    // --- ここからJavaScript ---
    document.addEventListener('DOMContentLoaded', function() {
        const csvFileInput = document.getElementById('csvFile');
        const projectTableBody = document.getElementById('projectTableBody');
        const loader = document.getElementById('loader');
        const mainContent = document.getElementById('mainContent');
        const errorMessageDiv = document.getElementById('errorMessage');
        const overallProgressPie = document.getElementById('overallProgressPie').querySelector('.progress-pie-chart-inner');
        const overallProgressText = document.getElementById('overallProgressText');
        const totalTasksSpan = document.getElementById('totalTasks');
        const completedTasksSpan = document.getElementById('completedTasks');
        const incompleteTasksSpan = document.getElementById('incompleteTasks');
        const delayedTasksSummarySpan = document.getElementById('delayedTasksSummary');
        const dueSoonTasksSummarySpan = document.getElementById('dueSoonTasksSummary');
        const assigneeSummaryTableBody = document.getElementById('assigneeSummaryTable').querySelector('tbody');
        const filterDaiKomokuSelect = document.getElementById('filterDaiKomoku');
        const filterTantouSelect = document.getElementById('filterTantou');
        const filterStatusSelect = document.getElementById('filterStatus');
        const applyFilterButton = document.getElementById('applyFilterButton');
        const resetFilterButton = document.getElementById('resetFilterButton');
        const updateProgressButton = document.getElementById('updateProgressButton'); 
        const tableHeaders = document.querySelectorAll('#projectTable th[data-sort]');
        let currentSort = { column: null, direction: 'asc' };
        const helpIcon = document.getElementById('helpIcon');
        const legendModal = document.getElementById('legendModal');
        const closeLegendModalButton = document.getElementById('closeLegendModal');
        const detailModal = document.getElementById('detailModal');
        const closeDetailModalButton = document.getElementById('closeDetailModalButton');
        const detailModalTitle = document.getElementById('detailModalTitle');
        const detailModalBody = document.getElementById('detailModalBody');

        let originalData = [];
        let displayData = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const DUE_SOON_DAYS = 3;

        const COLUMN_MAPPING = {
            '大項目': 'daiKomoku', '中項目': 'chuKomoku', '小項目': 'shoKomoku',
            '実施内容': 'jisshiNaiyo', '開始日予定日': 'kaishiYoteiBi', '終了日予定日': 'shuryoYoteiBi',
            '開始日': 'kaishiBi', '終了日': 'shuryoBi', '担当': 'tantou',
            '進捗率': 'shinchokuRitsu', '備考': 'bikou'
        };
        const REVERSE_COLUMN_MAPPING = {};
        for (const key in COLUMN_MAPPING) {
            if (COLUMN_MAPPING.hasOwnProperty(key)) {
                if (!REVERSE_COLUMN_MAPPING[COLUMN_MAPPING[key]]) {
                    REVERSE_COLUMN_MAPPING[COLUMN_MAPPING[key]] = key;
                }
            }
        }

        csvFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                loader.style.display = 'block'; mainContent.style.display = 'none';
                errorMessageDiv.style.display = 'none'; projectTableBody.innerHTML = '';
                if (typeof Papa === 'undefined' || typeof Papa.parse !== 'function') {
                    loader.style.display = 'none'; showError('CSV解析ライブラリ(PapaParse)が正しく読み込まれていません。HTML内の指示に従ってライブラリを組み込んでください。'); return;
                }
                Papa.parse(file, {
                    header: true, skipEmptyLines: true, encoding: "UTF-8",
                    complete: function(results) {
                        loader.style.display = 'none';
                        if (results.errors && results.errors.length > 0) { showError(`CSV解析エラー: ${results.errors[0].message}.`); return; }
                        if (!results.data || results.data.length === 0) { showError("CSVが空か読み取れませんでした。"); return; }
                        if (typeof results.data[0] !== 'object' || results.data[0] === null) { showError("CSVヘッダーが正しく認識されません。"); return; }
                        const headers = Object.keys(results.data[0]);
                        let missingColumns = [];
                        const strictlyRequiredInternalKeys = ['daiKomoku', 'chuKomoku', 'shoKomoku'];
                        for (const internalKey of strictlyRequiredInternalKeys) {
                            const possibleCsvHeaders = Object.keys(COLUMN_MAPPING).filter(k => COLUMN_MAPPING[k] === internalKey);
                            if (!possibleCsvHeaders.some(csvHeader => headers.includes(csvHeader))) {
                                missingColumns.push(REVERSE_COLUMN_MAPPING[internalKey] || internalKey);
                            }
                        }
                        if (missingColumns.length > 0) { showError(`必須列が見つかりません: ${missingColumns.join(', ')}。`); return; }
                        originalData = processCsvData(results.data);
                        populateFilters(originalData);
                        applyFiltersAndSort();
                        mainContent.style.display = 'block';
                    },
                    error: function(error) { loader.style.display = 'none'; showError(`CSV読み込みエラー: ${error.message}`);}
                });
            }
        });

        if (updateProgressButton) {
            updateProgressButton.addEventListener('click', function() {
                if (originalData.length === 0) {
                    alert("更新するデータがありません。CSVファイルをアップロードしてください。"); // alertの代わりにカスタムUI推奨
                    return;
                }
                originalData = calculateProgressCounts(originalData);
                applyFiltersAndSort();
                // alert("進捗が更新されました。"); // 更新完了の通知
            });
        }


        function processCsvData(data) {
            let processed = [];
            let lastSeenDaiKomokuName = ""; 
            let lastSeenChuKomokuName = ""; 

            let activeDaiKomokuObject = null;
            let activeChuKomokuObject = null;

            let daiKomokuIdCounter = 0;
            let chuKomokuIdCounter = 0;
            let shoKomokuIdCounter = 0;

            data.forEach((row) => {
                const normalizedRow = {};
                for (const csvHeader in COLUMN_MAPPING) {
                    if (row.hasOwnProperty(csvHeader) && COLUMN_MAPPING.hasOwnProperty(csvHeader)) {
                        normalizedRow[COLUMN_MAPPING[csvHeader]] = String(row[csvHeader]).trim();
                    }
                }

                if (!normalizedRow.shoKomoku || normalizedRow.shoKomoku === "") {
                    if (normalizedRow.daiKomoku && normalizedRow.daiKomoku !== "") {
                        lastSeenDaiKomokuName = normalizedRow.daiKomoku;
                        lastSeenChuKomokuName = (normalizedRow.chuKomoku && normalizedRow.chuKomoku !== "") ? normalizedRow.chuKomoku : "未分類(中)";
                    } else if (normalizedRow.chuKomoku && normalizedRow.chuKomoku !== "") {
                        lastSeenChuKomokuName = normalizedRow.chuKomoku;
                    }
                    return; 
                }

                let taskDaiKomokuName, taskChuKomokuName;

                if (normalizedRow.daiKomoku && normalizedRow.daiKomoku !== "") {
                    taskDaiKomokuName = normalizedRow.daiKomoku;
                    lastSeenDaiKomokuName = taskDaiKomokuName;
                    taskChuKomokuName = (normalizedRow.chuKomoku && normalizedRow.chuKomoku !== "") ? normalizedRow.chuKomoku : "未分類(中)";
                    lastSeenChuKomokuName = taskChuKomokuName;
                } else {
                    taskDaiKomokuName = lastSeenDaiKomokuName || "未分類(大)";
                }

                if (normalizedRow.chuKomoku && normalizedRow.chuKomoku !== "") {
                    taskChuKomokuName = normalizedRow.chuKomoku;
                    lastSeenChuKomokuName = taskChuKomokuName;
                } else {
                    if (taskDaiKomokuName === lastSeenDaiKomokuName) {
                         taskChuKomokuName = lastSeenChuKomokuName || "未分類(中)";
                    } else { 
                        taskChuKomokuName = "未分類(中)";
                        lastSeenChuKomokuName = taskChuKomokuName; 
                    }
                }

                const task = {
                    id: `task-${shoKomokuIdCounter++}`,
                    daiKomoku: taskDaiKomokuName,
                    chuKomoku: taskChuKomokuName,
                    shoKomoku: normalizedRow.shoKomoku,
                    jisshiNaiyo: normalizedRow.jisshiNaiyo || "",
                    kaishiYoteiBi: parseDate(normalizedRow.kaishiYoteiBi),
                    shuryoYoteiBi: parseDate(normalizedRow.shuryoYoteiBi),
                    kaishiBi: parseDate(normalizedRow.kaishiBi),
                    shuryoBi: parseDate(normalizedRow.shuryoBi),
                    tantou: normalizedRow.tantou || "",
                    shinchokuRitsu: parseProgress(normalizedRow.shinchokuRitsu),
                    bikou: normalizedRow.bikou || "",
                    level: 2, isCompleted: parseProgress(normalizedRow.shinchokuRitsu) === 100,
                    children: [], parentId: null, isCollapsed: false
                };
                task.isDelayed = !task.isCompleted && task.shuryoBi instanceof Date && task.shuryoBi < today;
                const diffTime = task.shuryoBi instanceof Date ? task.shuryoBi.getTime() - today.getTime() : Infinity;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                task.isDueSoon = !task.isCompleted && task.shuryoBi instanceof Date && diffDays >= 0 && diffDays <= DUE_SOON_DAYS;

                if (!activeDaiKomokuObject || activeDaiKomokuObject.daiKomoku !== task.daiKomoku) {
                    activeDaiKomokuObject = { id: `dai-${daiKomokuIdCounter++}`, daiKomoku: task.daiKomoku, level: 0, children: [], isCollapsed: false };
                    processed.push(activeDaiKomokuObject);
                    activeChuKomokuObject = null; 
                }
                if (!activeDaiKomokuObject) { console.error("Logic Error: DaiKomoku object not found for task", task); return; }

                if (!activeChuKomokuObject || activeChuKomokuObject.chuKomoku !== task.chuKomoku || activeChuKomokuObject.parentId !== activeDaiKomokuObject.id) {
                    activeChuKomokuObject = { id: `chu-${chuKomokuIdCounter++}`, chuKomoku: task.chuKomoku, daiKomoku: task.daiKomoku, level: 1, children: [], isCollapsed: false, parentId: activeDaiKomokuObject.id };
                    activeDaiKomokuObject.children.push(activeChuKomokuObject);
                }
                if (!activeChuKomokuObject) { console.error("Logic Error: ChuKomoku object not found for task", task); return; }
                
                task.parentId = activeChuKomokuObject.id;
                activeChuKomokuObject.children.push(task);
            });
            return calculateProgressCounts(processed);
        }

        function calculateProgressCounts(hierarchicalData) {
            hierarchicalData.forEach(dai => {
                let daiTotal = 0, daiCompleted = 0;
                if (dai.children) {
                    dai.children.forEach(chu => {
                        let chuTotal = 0, chuCompleted = 0;
                        if (chu.children) {
                            chu.children.forEach(sho => {
                                chuTotal++;
                                if (sho.isCompleted) chuCompleted++;
                            });
                        }
                        chu.totalCount = chuTotal; chu.completedCount = chuCompleted;
                        daiTotal += chuTotal; daiCompleted += chuCompleted;
                    });
                }
                dai.totalCount = daiTotal; dai.completedCount = daiCompleted;
            });
            return hierarchicalData;
        }
        function parseDate(dateString) {
            if (!dateString) return null;
            const cleanedDateString = String(dateString).trim();
            const parts = cleanedDateString.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
            if (parts) {
                const year = parseInt(parts[1]);
                const month = parseInt(parts[2]) - 1;
                const day = parseInt(parts[3]);
                const date = new Date(Date.UTC(year, month, day));
                if (date.getUTCFullYear() === year && date.getUTCMonth() === month && date.getUTCDate() === day) {
                    return date;
                }
            }
            return null;
        }
        function formatDate(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) return "";
            return `${date.getUTCFullYear()}/${String(date.getUTCMonth() + 1).padStart(2, '0')}/${String(date.getUTCDate()).padStart(2, '0')}`;
        }
        function parseProgress(progressString) {
            if (progressString === null || progressString === undefined || String(progressString).trim() === "") return 0;
            const num = parseFloat(String(progressString).replace('%', '').trim());
            return isNaN(num) ? 0 : Math.max(0, Math.min(100, num));
        }
        function renderTable(dataToRender) {
            projectTableBody.innerHTML = '';
            if (!dataToRender || dataToRender.length === 0) {
                const row = projectTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = projectTable.rows[0].cells.length;
                cell.textContent = '表示するデータがありません。';
                cell.style.textAlign = 'center'; cell.style.padding = '20px';
                return;
            }
            dataToRender.forEach(item => appendRowRecursive(item, projectTableBody));
            addToggleEventListeners();
        }
        
        function appendRowRecursive(item, parentElement) {
            const row = parentElement.insertRow();
            row.dataset.id = item.id;
            row.classList.add('task-row', `level-${item.level}`);
            if (item.isCollapsed) row.classList.add('collapsed');
            if (item.level === 2) {
                if (item.isDelayed) row.classList.add('status-delayed');
                if (item.isDueSoon) row.classList.add('status-due-soon');
                if (item.isCompleted) row.classList.add('status-completed');
            }

            if (item.level === 0) { // 大項目行
                const cellDai = row.insertCell();
                const toggleIcon = document.createElement('span'); toggleIcon.className = 'toggle-icon';
                if (item.children && item.children.length > 0) toggleIcon.dataset.targetId = item.id; else toggleIcon.style.visibility = 'hidden';
                cellDai.appendChild(toggleIcon); cellDai.appendChild(document.createTextNode(item.daiKomoku));
                if (item.totalCount !== undefined) { const countSpan = document.createElement('span'); countSpan.className = 'progress-count'; countSpan.textContent = ` (${item.completedCount || 0}/${item.totalCount || 0})`; cellDai.appendChild(countSpan); }
                cellDai.colSpan = 9; 

                const cellShinchoku = row.insertCell();
                let progressPercent = 0;
                if (item.totalCount > 0) progressPercent = (item.completedCount / item.totalCount) * 100;
                cellShinchoku.appendChild(createPieChart(progressPercent)); 
                cellShinchoku.appendChild(document.createTextNode(` ${Math.round(progressPercent)}%`));
                
                row.insertCell(); // 備考列用の空セル

            } else if (item.level === 1) { // 中項目行
                row.insertCell(); 
                const cellChu = row.insertCell();
                cellChu.classList.add('chu-komoku-cell'); // CSSでインデント調整用
                const toggleIcon = document.createElement('span'); toggleIcon.className = 'toggle-icon';
                if (item.children && item.children.length > 0) toggleIcon.dataset.targetId = item.id; else toggleIcon.style.visibility = 'hidden';
                cellChu.appendChild(toggleIcon); cellChu.appendChild(document.createTextNode(item.chuKomoku)); 
                 if (item.totalCount !== undefined) { const countSpan = document.createElement('span'); countSpan.className = 'progress-count'; countSpan.textContent = ` (${item.completedCount || 0}/${item.totalCount || 0})`; cellChu.appendChild(countSpan); }
                cellChu.colSpan = 8; 
                
                const cellShinchoku = row.insertCell();
                let progressPercent = 0;
                if (item.totalCount > 0) progressPercent = (item.completedCount / item.totalCount) * 100;
                cellShinchoku.appendChild(createPieChart(progressPercent)); 
                cellShinchoku.appendChild(document.createTextNode(` ${Math.round(progressPercent)}%`));
                row.insertCell(); 

            } else if (item.level === 2) { // 小項目行
                row.insertCell(); 
                row.insertCell(); 
                const cellSho = row.insertCell(); 
                cellSho.classList.add('sho-komoku-cell'); // CSSでインデントと幅調整用
                const toggleIcon = document.createElement('span'); toggleIcon.className = 'toggle-icon'; toggleIcon.style.visibility = 'hidden';
                cellSho.appendChild(toggleIcon); cellSho.appendChild(document.createTextNode(item.shoKomoku)); 
                const countSpan = document.createElement('span'); countSpan.className = 'progress-count'; countSpan.textContent = ` (${item.isCompleted ? 1 : 0}/1)`; cellSho.appendChild(countSpan);

                const cellJisshi = row.insertCell();
                if (item.jisshiNaiyo && String(item.jisshiNaiyo).trim() !== "") {
                    const detailButton = document.createElement('button');
                    detailButton.textContent = '詳細';
                    detailButton.className = 'action-button small';
                    detailButton.addEventListener('click', function() {
                        const modalTitle = `「${item.shoKomoku}」の詳細`;
                        let modalBodyContent = `<h4>実施内容:</h4><p>${(item.jisshiNaiyo || "").replace(/\n/g, '<br>')}</p>`;
                        if (item.bikou && String(item.bikou).trim() !== "") {
                            modalBodyContent += `<hr><h4>備考:</h4><p>${(item.bikou || "").replace(/\n/g, '<br>')}</p>`;
                        }
                        openDetailModal(modalTitle, modalBodyContent);
                    });
                    cellJisshi.appendChild(detailButton); 
                }
                row.insertCell().textContent = formatDate(item.kaishiYoteiBi);
                row.insertCell().textContent = formatDate(item.shuryoYoteiBi);
                row.insertCell().textContent = formatDate(item.kaishiBi);
                row.insertCell().textContent = formatDate(item.shuryoBi);
                row.insertCell().textContent = (item.tantou || '');
                
                const cellShinchoku = row.insertCell(); 
                cellShinchoku.appendChild(createPieChart(item.shinchokuRitsu));
    
                const progressSelect = document.createElement('select');
                progressSelect.className = 'progress-select';
                let currentProgressRounded = Math.round(item.shinchokuRitsu);
                
                const progressOptions = [0, 30, 50, 80, 100];
                if (!progressOptions.includes(currentProgressRounded)) {
                    progressOptions.push(currentProgressRounded);
                    progressOptions.sort((a,b) => a - b);
                }

                progressOptions.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = `${val}%`;
                    if (val === currentProgressRounded) {
                        option.selected = true;
                    }
                    progressSelect.appendChild(option);
                });

                progressSelect.addEventListener('change', function(e) {
                    const newProgress = parseInt(e.target.value);
                    updateTaskProgressInOriginalData(item.id, newProgress);
                });
                cellShinchoku.appendChild(progressSelect);

                const cellBikou = row.insertCell();
                const remarksTextarea = document.createElement('textarea');
                remarksTextarea.className = 'remarks-textarea';
                remarksTextarea.value = item.bikou || '';
                cellBikou.appendChild(remarksTextarea); 
            }

            if (!item.isCollapsed && item.children && item.children.length > 0) {
                item.children.forEach(child => appendRowRecursive(child, parentElement));
            }
        }

        function updateTaskProgressInOriginalData(taskId, newProgress) {
            function findAndUpdate(items) {
                for (const item of items) {
                    if (item.id === taskId) {
                        item.shinchokuRitsu = newProgress;
                        item.isCompleted = (newProgress === 100);
                        // 遅延・期日近接ステータスも再評価
                        item.isDelayed = !item.isCompleted && item.shuryoBi instanceof Date && item.shuryoBi < today;
                        const diffTime = item.shuryoBi instanceof Date ? item.shuryoBi.getTime() - today.getTime() : Infinity;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        item.isDueSoon = !item.isCompleted && item.shuryoBi instanceof Date && diffDays >= 0 && diffDays <= DUE_SOON_DAYS;
                        return true;
                    }
                    if (item.children && findAndUpdate(item.children)) {
                        return true;
                    }
                }
                return false;
            }
            findAndUpdate(originalData);
        }

        function addToggleEventListeners() {
            const oldIcons = projectTableBody.querySelectorAll('.toggle-icon[data-target-id]');
            oldIcons.forEach(icon => {
                const newIcon = icon.cloneNode(true);
                icon.parentNode.replaceChild(newIcon, icon);
                newIcon.addEventListener('click', function() {
                    const targetId = this.dataset.targetId;
                    toggleCollapse(targetId, originalData);
                    applyFiltersAndSort(); 
                });
            });
        }
        function toggleCollapse(itemId, dataArray) {
            for (const item of dataArray) {
                if (item.id === itemId) { item.isCollapsed = !item.isCollapsed; return true; }
                if (item.children && item.children.length > 0) { if (toggleCollapse(itemId, item.children)) return true; }
            }
            return false;
        }
        function createPieChart(progress) {
            const chart = document.createElement('div'); chart.className = 'progress-pie-chart';
            const innerChart = document.createElement('div'); innerChart.className = 'progress-pie-chart-inner';
            let color = 'var(--danger-color)';
            if (progress >= 70) color = 'var(--secondary-color)'; else if (progress >= 30) color = 'var(--warning-color)';
            innerChart.style.backgroundImage = `conic-gradient(${color} 0% ${progress}%, #efefef ${progress}% 100%)`;
            chart.appendChild(innerChart); return chart;
        }
        function populateFilters(data) {
            const daiKomokus = new Set(); const tantous = new Set();
            function extractFilterValuesRecursive(items) {
                items.forEach(item => {
                    if (item.level === 0 && item.daiKomoku) daiKomokus.add(item.daiKomoku);
                    if (item.level === 2 && item.tantou) tantous.add(item.tantou);
                    if (item.children) extractFilterValuesRecursive(item.children);
                });
            }
            extractFilterValuesRecursive(data);
            populateSelect(filterDaiKomokuSelect, Array.from(daiKomokus).sort());
            populateSelect(filterTantouSelect, Array.from(tantous).sort());
        }
        function populateSelect(selectElement, options) {
            while (selectElement.options.length > 1) selectElement.remove(1);
            options.forEach(optionValue => { if(optionValue) { const option = document.createElement('option'); option.value = optionValue; option.textContent = optionValue; selectElement.appendChild(option); }});
        }
        function deepCopyWithDates(obj) {
            if (obj === null || typeof obj !== 'object') return obj;
            if (obj instanceof Date) return new Date(obj.getTime());
            if (Array.isArray(obj)) return obj.map(item => deepCopyWithDates(item));
            const copy = {};
            for (const key in obj) { if (obj.hasOwnProperty(key)) copy[key] = deepCopyWithDates(obj[key]); }
            return copy;
        }
        applyFilterButton.addEventListener('click', applyFiltersAndSort);
        resetFilterButton.addEventListener('click', () => {
            filterDaiKomokuSelect.value = ""; filterTantouSelect.value = ""; filterStatusSelect.value = "";
            currentSort = { column: null, direction: 'asc' }; updateSortIcons(); applyFiltersAndSort();
        });
        function applyFiltersAndSort() {
            let dataToProcess = deepCopyWithDates(originalData);
            const selectedDaiKomoku = filterDaiKomokuSelect.value; const selectedTantou = filterTantouSelect.value; const selectedStatus = filterStatusSelect.value;
            let filteredData = dataToProcess.filter(dai => {
                if (selectedDaiKomoku && dai.daiKomoku !== selectedDaiKomoku) return false;
                if (dai.children) {
                    dai.children = dai.children.filter(chu => {
                        if (chu.children) {
                            chu.children = chu.children.filter(sho => {
                                if (selectedTantou && sho.tantou !== selectedTantou) return false;
                                if (selectedStatus) {
                                    if (selectedStatus === "未着手" && sho.shinchokuRitsu > 0) return false;
                                    if (selectedStatus === "進行中" && (sho.shinchokuRitsu === 0 || sho.shinchokuRitsu === 100)) return false;
                                    if (selectedStatus === "完了" && sho.shinchokuRitsu < 100) return false;
                                    if (selectedStatus === "遅延" && !sho.isDelayed) return false;
                                    if (selectedStatus === "期日近接" && !sho.isDueSoon) return false;
                                } return true;
                            }); return chu.children.length > 0;
                        } return false;
                    }); return dai.children.length > 0;
                } return false;
            });
            if (currentSort.column) {
                filteredData.forEach(dai => { if (dai.children) { dai.children.forEach(chu => { if (chu.children) {
                    chu.children.sort((a, b) => {
                        let valA = a[currentSort.column]; let valB = b[currentSort.column];
                        if (currentSort.column === 'kaishiBi' || currentSort.column === 'shuryoBi' || currentSort.column === 'kaishiYoteiBi' || currentSort.column === 'shuryoYoteiBi') {
                            valA = (valA instanceof Date) ? valA.getTime() : (currentSort.direction === 'asc' ? Infinity : -Infinity);
                            valB = (valB instanceof Date) ? valB.getTime() : (currentSort.direction === 'asc' ? Infinity : -Infinity);
                        } else if (currentSort.column === 'shinchokuRitsu') {
                            valA = parseFloat(valA || 0); valB = parseFloat(valB || 0);
                        } else if (typeof valA === 'string' && typeof valB === 'string') {
                            valA = valA.toLowerCase(); valB = valB.toLowerCase();
                        } else {
                            if (valA === undefined || valA === null) valA = currentSort.direction === 'asc' ? '' : 'zzzz';
                            if (valB === undefined || valB === null) valB = currentSort.direction === 'asc' ? '' : 'zzzz';
                            if (typeof valA !== typeof valB) { valA = String(valA); valB = String(valB); }
                        }
                        if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }});}});
            }
            displayData = filteredData; renderTable(displayData); updateSummary(displayData);
        }
        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.dataset.sort; if (!sortKey) return;
                if (currentSort.column === sortKey) { currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc'; }
                else { currentSort.column = sortKey; currentSort.direction = 'asc'; }
                updateSortIcons(); applyFiltersAndSort();
            });
        });
        function updateSortIcons() {
            tableHeaders.forEach(th => { const icon = th.querySelector('.sort-icon'); if (icon) { icon.textContent = (th.dataset.sort === currentSort.column) ? (currentSort.direction === 'asc' ? '▲' : '▼') : ''; }});
        }
        function updateSummary(dataForSummary) {
            let total = 0, completed = 0, delayed = 0, dueSoon = 0; const assigneeStats = {};
            function countTasksRecursive(items) {
                items.forEach(item => {
                    if (item.level === 2) {
                        total++; const assignee = item.tantou || "未担当";
                        if (!assigneeStats[assignee]) assigneeStats[assignee] = { total: 0, completed: 0, delayed: 0, dueSoon: 0, incomplete: 0 };
                        assigneeStats[assignee].total++;
                        if (item.isCompleted) { completed++; assigneeStats[assignee].completed++; }
                        else { assigneeStats[assignee].incomplete++; if (item.isDelayed) { delayed++; assigneeStats[assignee].delayed++; } if (item.isDueSoon) { dueSoon++; assigneeStats[assignee].dueSoon++; } }
                    }
                    if (item.children) countTasksRecursive(item.children);
                });
            }
            countTasksRecursive(dataForSummary);
            totalTasksSpan.textContent = total; completedTasksSpan.textContent = completed; incompleteTasksSpan.textContent = total - completed;
            delayedTasksSummarySpan.textContent = delayed; dueSoonTasksSummarySpan.textContent = dueSoon;
            const overallProgress = total > 0 ? Math.round((completed / total) * 100) : 0;
            overallProgressText.textContent = `${overallProgress}%`;
            if (overallProgressPie) overallProgressPie.style.backgroundImage = createPieChart(overallProgress).querySelector('.progress-pie-chart-inner').style.backgroundImage;
            assigneeSummaryTableBody.innerHTML = '';
            for (const assignee in assigneeStats) { if (assigneeStats.hasOwnProperty(assignee)) {
                const stats = assigneeStats[assignee]; const row = assigneeSummaryTableBody.insertRow();
                row.insertCell().textContent = assignee; row.insertCell().textContent = stats.total; row.insertCell().textContent = stats.incomplete;
                row.insertCell().textContent = stats.completed; row.insertCell().textContent = stats.delayed; row.insertCell().textContent = stats.dueSoon;
            }}
        }
        function showError(message) { errorMessageDiv.textContent = message; errorMessageDiv.style.display = 'block'; console.error("Application Error (showError):", message); }
        function openDetailModal(title, content) { detailModalTitle.textContent = title; detailModalBody.innerHTML = content; detailModal.classList.add('active'); }
        function closeDetailModal() { detailModal.classList.remove('active'); }
        closeDetailModalButton.addEventListener('click', closeDetailModal);
        detailModal.addEventListener('click', function(event) { if (event.target === detailModal) closeDetailModal(); });
        helpIcon.addEventListener('click', () => { legendModal.classList.add('active'); });
        closeLegendModalButton.addEventListener('click', () => { legendModal.classList.remove('active'); });
        legendModal.addEventListener('click', (event) => { if (event.target === legendModal) legendModal.classList.remove('active'); });
    });
    </script>
</body>
</html>
